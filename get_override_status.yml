---
- name: Get Templates Override Status
  hosts: panorama
  connection: local

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
    template_stacks:
      - Firewall_Incorrect_Stack
      - Firewall2_Incorrect_Stack
      - Firewall_Correct_Stack

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Gather facts for device
      paloaltonetworks.panos.panos_facts:
        provider: "{{ device }}"

    - name: Display information
      ansible.builtin.debug:
        msg:
          - "Hostname: {{ ansible_facts['net_hostname'] }}"
          - "Serial: {{ ansible_facts['net_serial'] }}"
          - "Model: {{ ansible_facts['net_model'] }}"
          - "Version: {{ ansible_facts['net_version'] }}"
          - "Uptime: {{ ansible_facts['net_uptime'] }}"
          - "HA Enabled: {{ ansible_facts['net_ha_enabled'] }}"
          - "HA Type: {{ ansible_facts['net_ha_localmode'] }}"
          - "HA Status: {{ ansible_facts['net_ha_localstate'] }}"
          - "Multi-VSYS: {{ ansible_facts['net_multivsys'] }}"
          #- "{{ ansible_facts['net_session_usage'] }} out of {{ ansible_facts['net_session_max'] }} sessions in use"
    
    - name: Get Template Stacks Info
      paloaltonetworks.panos.panos_template_stack:
        provider: "{{ device }}"
        name: "{{ item }}"
        state: 'gathered'
      register: stack_result_raw
      loop: "{{ template_stacks }}"
    
    - name: Extract gathered template stack data into a clean list
      ansible.builtin.set_fact:
        stack_result: >-
          {{
            stack_result_raw.results
            | map(attribute='gathered')
            | select('defined')
            | flatten
            | list
          }}
    
    - name: Map template stack name to first template
      ansible.builtin.set_fact:
        stack_to_template: >-
          {{
            stack_to_template | default({})
            | combine({
                item.name: (item.templates | first)
              })
          }}
      loop: "{{ stack_result }}"
      when:
        - item.templates is defined
        - item.templates | length > 0

    - name: Map template stack name to global template
      ansible.builtin.set_fact:
        stack_to_global: >-
          {{
            stack_to_global | default({})
            | combine({
                item.name: (item.templates | last)
              })
          }}
      loop: "{{ stack_result }}"
      when:
        - item.templates is defined
        - item.templates | length > 0

    - name: Pull management permitted IPs from template + template stack
      vars:
        template_xpath: >-
          /config/devices/entry[@name='localhost.localdomain']/template/entry[@name='{{ stack_to_global[item] }}']
          /config/devices/entry[@name='localhost.localdomain']/deviceconfig/system/permitted-ip
        stack_xpath: >-
          /config/devices/entry[@name='localhost.localdomain']/template-stack/entry[@name='{{ item }}']
          /config/devices/entry[@name='localhost.localdomain']/deviceconfig/system/permitted-ip
      block:

        - name: Get permitted IPs from GLOBAL TEMPLATE in the stack
          paloaltonetworks.panos.panos_type_cmd:
            provider: "{{ device }}"
            cmd: "get"
            xpath: "{{ template_xpath | regex_replace('\\s+', '') }}"
          register: permitted_from_template_raw
          loop: "{{ template_stacks }}"
          loop_control:
            loop_var: item
            label: "stack={{ item }} template={{ stack_to_global[item] }}"

        - name: Get permitted IPs from TEMPLATE STACK config
          paloaltonetworks.panos.panos_type_cmd:
            provider: "{{ device }}"
            cmd: "get"
            xpath: "{{ stack_xpath | regex_replace('\\s+', '') }}"
          register: permitted_from_stack_raw
          loop: "{{ template_stacks }}"
          loop_control:
            loop_var: item
            label: "stack={{ item }}"

        # Parse XML -> list of entry names (IP/subnet). This is the key extraction.
        # We look for: <entry name="1.2.3.4/32"> or <entry name="10.0.0.0/8">
        - name: Build a per-stack report (stack, template, template_permitted_ips, stack_permitted_ips)
          ansible.builtin.set_fact:
            mgmt_permitted_ip_report: >-
              {{
                mgmt_permitted_ip_report | default([])
                + [ {
                  'stack': item,
                  'template': stack_to_global[item],
                  'template_permitted_ips': (
                    (permitted_from_template_raw.results
                      | selectattr('item', 'equalto', item)
                      | map(attribute='stdout_xml')
                      | first
                      | default('')
                    )
                    | regex_findall('entry name=\"([^\"]+)\"')
                    | list
                  ),
                  'stack_permitted_ips': (
                    (permitted_from_stack_raw.results
                      | selectattr('item', 'equalto', item)
                      | map(attribute='stdout_xml')
                      | first
                      | default('')
                    )
                    | regex_findall('entry name=\"([^\"]+)\"')
                    | list
                  )
                } ]
              }}
          loop: "{{ template_stacks }}"

    - name: Compute missing permitted IPs (template not present in stack)
      ansible.builtin.set_fact:
        permitted_ip_compliance: >-
          {{
            (permitted_ip_compliance | default([]))
            + [ item | combine({
                'missing_in_stack': (
                  (item.template_permitted_ips | default([]))
                  | difference(item.stack_permitted_ips | default([]))
                )
              })
              ]
          }}
      loop: "{{ mgmt_permitted_ip_report }}"

    - name: Write missing permitted IPs CSV report (AAP artifact)
      ansible.builtin.template:
        src: missing_mgmt_ips.csv.j2
        dest: /runner/artifacts/missing_mgmt_permitted_ips.csv
        mode: '0644'

    - name: Slurp CSV (base64)
      ansible.builtin.slurp:
        src: /runner/artifacts/missing_mgmt_permitted_ips.csv
      register: csv_slurp

    - name: Print base64 CSV to job output (copy/paste safe)
      ansible.builtin.debug:
        msg: |
          =====BEGIN_MISSING_MGMT_PERMITTED_IPS_CSV_BASE64=====
          {{ csv_slurp.content }}
          =====END_MISSING_MGMT_PERMITTED_IPS_CSV_BASE64=====

# Need to build logic to grab the 400 firewalls
# Need to grab the mgmt ips and stack names from the firewalls
# Might want to consider checking to see if the mgmt ip in the stack is correct
# Might want to check to see if there are other ips in the override that aren't the mgmt ips
# Update data output format to match json format of other projects
# List generation and data validation/file generation will be seperate playbooks
