---
- name: Get Templates Override Status
  hosts: "{{ workflow_target_host }}"
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ panorama_username }}"
      password: "{{ panorama_password }}"
    mgmt_variable_names:
      - '$fw-mgmt-ip-a'
      - '$fw-mgmt-ip-b'

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Gather facts for device
      paloaltonetworks.panos.panos_facts:
        provider: "{{ device }}"

    - name: Query Panorama for managed devices
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: "show devices all"
      register: panorama_devices_raw

    - name: Parse Panorama stdout JSON
      ansible.builtin.set_fact:
        panorama_devices_json: "{{ panorama_devices_raw.stdout | from_json }}"

    - name: Capture devices list from parsed stdout
      ansible.builtin.set_fact:
        panorama_devices_list: >-
          {{
            panorama_devices_json.response.result.devices.entry
            | default([])
          }}

    - name: Normalize requested cluster hostnames input
      vars:
        cluster_hostnames_raw: "{{ cluster_hostnames | default('') | string }}"
      ansible.builtin.set_fact:
        requested_cluster_hostnames: >-
          {{
            (
              cluster_hostnames_raw
              | replace('\\n', '\n')
              | replace(',', '\n')
            ).splitlines()
            | map('trim')
            | map('regex_replace', '^"|"$', '')
            | map('regex_replace', "^'|'$", '')
            | reject('equalto', '')
            | unique
            | list
          }}

    - name: Debug raw cluster hostname input
      ansible.builtin.debug:
        msg:
          cluster_hostnames_raw: "{{ cluster_hostnames | default('') }}"
          requested_cluster_hostnames: "{{ requested_cluster_hostnames | default([]) }}"

    - name: Validate provided cluster hostname format
      ansible.builtin.assert:
        that:
          - item is match('.*\d$')
        fail_msg: "Cluster hostname '{{ item }}' must end in a digit (example: host-name-100)."
      loop: "{{ requested_cluster_hostnames | default([]) }}"
      when: (requested_cluster_hostnames | default([]) | length) > 0

    - name: Expand cluster hostnames to device hostnames (.1 and .2 peers)
      ansible.builtin.set_fact:
        requested_device_hostnames: >-
          {{
            (requested_device_hostnames | default([]))
            + [
              (item | regex_replace('\d$', '1')),
              (item | regex_replace('\d$', '2'))
            ]
          }}
      loop: "{{ requested_cluster_hostnames | default([]) }}"
      when: (requested_cluster_hostnames | default([]) | length) > 0

    - name: Normalize expanded requested device hostnames
      ansible.builtin.set_fact:
        requested_device_hostnames: "{{ requested_device_hostnames | default([]) | unique | list }}"

    - name: Track requested hostnames not found in Panorama
      ansible.builtin.set_fact:
        requested_device_hostnames_not_found: >-
          {{
            (requested_device_hostnames | default([]))
            | difference(
                panorama_devices_list
                | map(attribute='hostname')
                | select('defined')
                | list
              )
          }}
      when: (requested_device_hostnames | default([]) | length) > 0

    - name: Track devices skipped because they are not 400-series
      ansible.builtin.set_fact:
        skipped_not_400_series: >-
          {{
            (skipped_not_400_series | default([]))
            + [ {
              'hostname': item.hostname | default(''),
              'serial': item.serial | default(''),
              'model': item.model | default('')
            } ]
          }}
      loop: "{{ panorama_devices_list }}"
      when:
        - (requested_device_hostnames | default([]) | length) == 0 or (item.hostname | default('')) in (requested_device_hostnames | default([]))
        - item.model is not defined or item.model is not string or (not item.model.startswith('PA-4'))

    - name: Extract PA-4 devices (serial, mgmt_ip, model, template-stack) from Panorama output
      ansible.builtin.set_fact:
        fw_400_devices: >-
          {{
            (fw_400_devices | default([]))
            + [ {
              'hostname': item.hostname | default(''),
              'serial': item.serial | default(''),
              'mgmt_ip': item['ip-address'] | default(''),
              'model': item.model | default(''),
            } ]
          }}
      loop: "{{ panorama_devices_list }}"
      when:
        - item.model is defined
        - item.model is string
        - item.model.startswith('PA-4')
        - (requested_device_hostnames | default([]) | length) == 0 or (item.hostname | default('')) in (requested_device_hostnames | default([]))

    - name: Debug discovered 400-series devices
      ansible.builtin.debug:
        var: fw_400_devices

    - name: Track 400-series devices missing management IP
      ansible.builtin.set_fact:
        fw_400_missing_mgmt_ip: >-
          {{
            (fw_400_missing_mgmt_ip | default([]))
            + [ {
              'hostname': item.hostname | default(''),
              'serial': item.serial | default(''),
              'model': item.model | default('')
            } ]
          }}
      loop: "{{ fw_400_devices | default([]) }}"
      when: (item.mgmt_ip | default('') | trim | length) == 0

    - name: Build list of 400-series devices with management IP
      ansible.builtin.set_fact:
        fw_400_devices_with_mgmt_ip: >-
          {{
            (fw_400_devices_with_mgmt_ip | default([]))
            + [ item ]
          }}
      loop: "{{ fw_400_devices | default([]) }}"
      when: (item.mgmt_ip | default('') | trim | length) > 0

    - name: Keep only 400-series devices with management IP
      ansible.builtin.set_fact:
        fw_400_devices: "{{ fw_400_devices_with_mgmt_ip | default([]) }}"

    - name: Build serial -> mgmt IP map for 400-series devices
      ansible.builtin.set_fact:
        fw_400_by_serial: >-
          {{
            (fw_400_by_serial | default({}))
            | combine({ item.serial: item.mgmt_ip })
          }}
      loop: "{{ fw_400_devices }}"

    - name: Gather all template stacks
      paloaltonetworks.panos.panos_template_stack:
        provider: "{{ device }}"
        state: gathered
        gathered_filter: '*'
      register: template_stack_result_raw_all

    - name: Debug discovered 400-series devices
      ansible.builtin.debug:
        var: template_stack_result_raw_all

    - name: Normalize gathered template stacks into a list
      ansible.builtin.set_fact:
        template_stack_all: "{{ template_stack_result_raw_all.gathered | default([]) }}"

    - name: Debug discovered 400-series devices
      ansible.builtin.debug:
        var: template_stack_all

    - name: Build list of 400-series serials
      ansible.builtin.set_fact:
        fw_400_serials: "{{ fw_400_devices | map(attribute='serial') | list }}"

    - name: Debug discovered 400-series devices
      ansible.builtin.debug:
        var: fw_400_serials

    - name: Build template stacks with 400-series member firewalls
      ansible.builtin.set_fact:
        template_stacks_with_400: >-
          {{
            (template_stacks_with_400 | default([]))
            + [ {
              'stack': item.name | default(''),
              'templates': item.templates | default([]),
              'member_firewalls': (
                (
                  ((item.devices | default(item.device | default([]))) | length > 0
                    and ((item.devices | default(item.device | default([]))) | first) is mapping)
                  | ternary(
                      (
                        (item.devices | default(item.device | default([])))
                        | map(attribute='serial')
                        | list
                      ),
                      (item.devices | default(item.device | default([])))
                    )
                )
                | intersect(fw_400_serials | default([]))
              )
            } ]
          }}
      loop: "{{ template_stack_all }}"
      when:
        - item is mapping
        - (
            (
              ((item.devices | default(item.device | default([]))) | length > 0
                and ((item.devices | default(item.device | default([]))) | first) is mapping)
              | ternary(
                  (
                    (item.devices | default(item.device | default([])))
                    | map(attribute='serial')
                    | list
                  ),
                  (item.devices | default(item.device | default([])))
                )
            )
            | intersect(fw_400_serials | default([]))
            | length
          ) > 0

    - name: Derive template stacks from template stack membership
      ansible.builtin.set_fact:
        template_stacks: "{{ template_stacks_with_400 | map(attribute='stack') | unique | list }}"

    - name: Debug discovered 400-series devices
      ansible.builtin.debug:
        var: template_stacks

    - name: Build mapping of template_stack -> mgmt IPs for 400-series firewalls
      ansible.builtin.set_fact:
        fw_400_by_stack: >-
          {{
            (fw_400_by_stack | default({}))
            | combine({
                item.stack: (
                  (item.member_firewalls | default([]))
                  | map('extract', fw_400_by_serial | default({}))
                  | select('defined')
                  | list
                )
              })
          }}
      loop: "{{ template_stacks_with_400 }}"

    - name: Get Template Stacks Info
      paloaltonetworks.panos.panos_template_stack:
        provider: "{{ device }}"
        name: "{{ item }}"
        state: 'gathered'
      register: template_stack_result_raw
      loop: "{{ fw_400_by_stack.keys() | list }}"
    
    - name: Extract gathered template stack data into a clean list
      ansible.builtin.set_fact:
        template_stack_result: >-
          {{
            template_stack_result_raw.results
            | map(attribute='gathered')
            | select('defined')
            | flatten
            | list
          }}
    
    - name: Map template stack name to first template
      ansible.builtin.set_fact:
        template_stack_to_template: >-
          {{
            template_stack_to_template | default({})
            | combine({
                item.name: (item.templates | first)
              })
          }}
      loop: "{{ template_stack_result }}"
      when:
        - item.templates is defined
        - item.templates | length > 0

    - name: Map template stack name to global template
      ansible.builtin.set_fact:
        template_stack_to_global: >-
          {{
            template_stack_to_global | default({})
            | combine({
                item.name: (item.templates | last)
              })
          }}
      loop: "{{ template_stack_result }}"
      when:
        - item.templates is defined
        - item.templates | length > 0

    - name: Build unique global template list for queried stacks
      ansible.builtin.set_fact:
        global_templates_for_queried_stacks: "{{ template_stack_to_global.values() | list | unique }}"

    - name: Pull management permitted IPs from template + template stack
      vars:
        template_xpath: >-
          /config/devices/entry[@name='localhost.localdomain']/template/entry[@name='{{ template_name }}']
          /config/devices/entry[@name='localhost.localdomain']/deviceconfig/system/permitted-ip
        stack_xpath: >-
          /config/devices/entry[@name='localhost.localdomain']/template-stack/entry[@name='{{ item }}']
          /config/devices/entry[@name='localhost.localdomain']/deviceconfig/system/permitted-ip
      block:

        - name: Get permitted IPs from each GLOBAL TEMPLATE only once
          paloaltonetworks.panos.panos_type_cmd:
            provider: "{{ device }}"
            cmd: "get"
            xpath: "{{ template_xpath | regex_replace('\\s+', '') }}"
          register: template_permitted_from_global_raw
          loop: "{{ global_templates_for_queried_stacks | default([]) }}"
          loop_control:
            loop_var: template_name
            label: "template={{ template_name }}"

        - name: Get permitted IPs from TEMPLATE STACK config
          paloaltonetworks.panos.panos_type_cmd:
            provider: "{{ device }}"
            cmd: "get"
            xpath: "{{ stack_xpath | regex_replace('\\s+', '') }}"
          register: template_stack_permitted_from_stack_raw
          loop: "{{ fw_400_by_stack.keys() | list }}"
          loop_control:
            loop_var: item
            label: "stack={{ item }}"

        # Parse XML -> list of entry names (IP/subnet). This is the key extraction.
        # We look for: <entry name="1.2.3.4/32"> or <entry name="10.0.0.0/8">
        - name: Build a per-stack report (stack, template, template_permitted_ips, stack_permitted_ips)
          ansible.builtin.set_fact:
            template_stack_mgmt_permitted_ips: >-
              {{
                template_stack_mgmt_permitted_ips | default([])
                + [ {
                  'stack': item,
                  'template': template_stack_to_global[item],
                  'template_permitted_ips': (
                    (template_permitted_from_global_raw.results
                      | selectattr('item', 'equalto', template_stack_to_global[item])
                      | map(attribute='stdout_xml')
                      | first
                      | default('')
                    )
                    | regex_findall('entry name="([^\"]+)"')
                    | list
                  ),
                  'stack_permitted_ips': (
                    (template_stack_permitted_from_stack_raw.results
                      | selectattr('item', 'equalto', item)
                      | map(attribute='stdout_xml')
                      | first
                      | default('')
                    )
                    | regex_findall('entry name="([^\"]+)"')
                    | list
                  )
                } ]
              }}
          loop: "{{ fw_400_by_stack.keys() | list }}"

    - name: Compute missing permitted IPs (template not present in stack)
      ansible.builtin.set_fact:
        template_stack_permitted_ip_compliance: >-
          {{
            (template_stack_permitted_ip_compliance | default([]))
            + [ item | combine({
                'missing_in_stack': (
                  (item.template_permitted_ips | default([]))
                  | difference(item.stack_permitted_ips | default([]))
                )
              })
              ]
          }}
      loop: "{{ template_stack_mgmt_permitted_ips }}"

    - name: Validate stack overrides against actual firewall mgmt IPs
      ansible.builtin.set_fact:
        template_stack_override_validation: >-
          {{
            (template_stack_override_validation | default([]))
            + [ {
                'stack': item.stack,
                'template_permitted_ips': (item.template_permitted_ips | default([])),
                'stack_permitted_ips': (item.stack_permitted_ips | default([])),
                'missing_in_stack': (item.missing_in_stack | default([])),
                'expected_mgmt_ips': (fw_400_by_stack[item.stack] | default([])),
                'overridden_ips': (
                  (item.stack_permitted_ips | default([]))
                  | difference(item.template_permitted_ips | default([]))
                ),
                'missing': (
                  (
                    (item.missing_in_stack | default([]))
                    + (
                      (fw_400_by_stack[item.stack] | default([]))
                      | difference(
                          (item.stack_permitted_ips | default([]))
                          | difference(item.template_permitted_ips | default([]))
                        )
                    )
                  )
                  | unique
                  | list
                ),
                'extra_in_override': (
                  (
                    (item.stack_permitted_ips | default([]))
                    | difference(item.template_permitted_ips | default([]))
                  )
                  | difference(fw_400_by_stack[item.stack] | default([]))
                )
              } ]
          }}
      loop: "{{ template_stack_permitted_ip_compliance }}"

    - name: Build dict of stack -> issue details for output
      ansible.builtin.set_fact:
        template_stack_issues_by_stack: >-
          {{
            (template_stack_issues_by_stack | default({}))
            | combine({
                item.stack: {
                  'template_permitted_ips': (item.template_permitted_ips | default([])),
                  'stack_permitted_ips': (item.stack_permitted_ips | default([])),
                  'expected_mgmt_ips': (item.expected_mgmt_ips | default([])),
                  'overridden_ips': (item.overridden_ips | default([])),
                  'override_ips': (item.overridden_ips | default([])),
                  'missing': (item.missing | default([])),
                  'extra_in_override': (item.extra_in_override | default([]))
                }
              })
          }}
      loop: "{{ template_stack_override_validation }}"

    - name: Build stacks that require override remediation
      ansible.builtin.set_fact:
        template_stacks_requiring_override_fix: >-
          {{
            (template_stacks_requiring_override_fix | default({}))
            | combine({ item.key: item.value })
          }}
      loop: "{{ template_stack_issues_by_stack | default({}) | dict2items }}"
      when:
        - ((item.value.override_ips | default([]) | length) > 0)
          or ((item.value.missing | default([]) | length) > 0)
          or (((mgmt_variable_names | default([])) | difference(item.value.stack_permitted_ips | default([])) | length) > 0)

    - name: Build device list requiring override remediation
      ansible.builtin.set_fact:
        devices_requiring_override_fix: >-
          {{
            (devices_requiring_override_fix | default([]))
            + [ {
              'stack': item.key,
              'member_serials': (
                template_stacks_with_400
                | default([])
                | selectattr('stack', 'equalto', item.key)
                | map(attribute='member_firewalls')
                | first
                | default([])
              ),
              'mgmt_ips': (fw_400_by_stack[item.key] | default([]))
            } ]
          }}
      loop: "{{ template_stacks_requiring_override_fix | default({}) | dict2items }}"

    - name: Debug stack issues dict
      ansible.builtin.debug:
        var: template_stack_issues_by_stack

    - name: Debug skipped items summary
      ansible.builtin.debug:
        msg:
          requested_cluster_hostnames: "{{ requested_cluster_hostnames | default([]) }}"
          requested_device_hostnames: "{{ requested_device_hostnames | default([]) }}"
          requested_device_hostnames_not_found: "{{ requested_device_hostnames_not_found | default([]) }}"
          skipped_not_400_series: "{{ skipped_not_400_series | default([]) }}"
          fw_400_missing_mgmt_ip: "{{ fw_400_missing_mgmt_ip | default([]) }}"

    - name: Debug stacks and devices requiring override remediation
      ansible.builtin.debug:
        msg:
          template_stacks_requiring_override_fix: "{{ template_stacks_requiring_override_fix | default({}) }}"
          devices_requiring_override_fix: "{{ devices_requiring_override_fix | default([]) }}"

    - name: Publish stack issues for downstream workflow nodes
      ansible.builtin.set_stats:
        data:
          template_stack_issues_by_stack: "{{ template_stack_issues_by_stack | default({}) }}"
          template_stacks_requiring_override_fix: "{{ template_stacks_requiring_override_fix | default({}) }}"
          devices_requiring_override_fix: "{{ devices_requiring_override_fix | default([]) }}"
          fw_400_missing_mgmt_ip: "{{ fw_400_missing_mgmt_ip | default([]) }}"
          requested_device_hostnames_not_found: "{{ requested_device_hostnames_not_found | default([]) }}"
          skipped_not_400_series: "{{ skipped_not_400_series | default([]) }}"
        per_host: false
        aggregate: false
